/*-------------------------------------------------
MSSV: 21120396 - 21120419 - 21120446
HO TEN CAC THANH VIEN NHOM:
							DAO THI NGOC GIAU
							VU THANH CONG
							KIEN DINH MY HANH
LAB: 04 - NHOM
NGAY: 25/05/2024
--------------------------------------------------*/
--CAU LENH TAO DATABASE
CREATE DATABASE QLSVNhom
GO
USE QLSVNhom
GO

/*-------------------------------------------------
MSSV: 21120396 - 21120419 - 21120446
HO TEN CAC THANH VIEN NHOM:
							DAO THI NGOC GIAU
							VU THANH CONG
							KIEN DINH MY HANH
LAB: 04 - NHOM
NGAY: 25/05/2024
--------------------------------------------------*/
--CAC CAU LENH TAO TABLE
USE QLSVNhom
GO

CREATE TABLE NHANVIEN
(
	MANV VARCHAR(20) NOT NULL PRIMARY KEY,
	HOTEN NVARCHAR(100) NOT NULL,
	EMAIL VARCHAR(20),
	LUONG VARBINARY(MAX),
	TENDN NVARCHAR(100) NOT NULL,
	MATKHAU VARBINARY(MAX) NOT NULL,
	PUBKEY VARCHAR(20) NOT NULL
)

CREATE TABLE LOP
(
	MALOP VARCHAR(20) PRIMARY KEY,
	TENLOP NVARCHAR(100) NOT NULL,
	MANV VARCHAR(20),
	FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)
)

CREATE TABLE SINHVIEN
(
	MASV VARCHAR(20) PRIMARY KEY,
	HOTEN NVARCHAR(100) NOT NULL,
	NGAYSINH DATETIME,
	DIACHI NVARCHAR(200),
	MALOP VARCHAR(20),
	TENDN NVARCHAR(100) NOT NULL,
	MATKHAU VARBINARY(MAX) NOT NULL,
	FOREIGN KEY(MALOP) REFERENCES LOP(MALOP)
)

CREATE TABLE HOCPHAN
(
	MAHP VARCHAR(20) PRIMARY KEY,
	TENHP NVARCHAR(100) NOT NULL,
	SOTC INT
)

CREATE TABLE BANGDIEM
(
	MASV VARCHAR(20),
	MAHP VARCHAR(20),
	DIEMTHI VARBINARY(MAX),
	--DIEMTHI INT,
	PRIMARY KEY(MASV, MAHP),
	FOREIGN KEY(MASV) REFERENCES SINHVIEN(MASV),
	FOREIGN KEY(MAHP) REFERENCES HOCPHAN(MAHP)
)

/*-------------------------------------------------
MSSV: 21120396 - 21120419 - 21120446
HO TEN CAC THANH VIEN NHOM:
							DAO THI NGOC GIAU
							VU THANH CONG
							KIEN DINH MY HANH
LAB: 04 - NHOM
NGAY: 25/05/2024
--------------------------------------------------*/
--CAU LENH TAO STORE PROCEDURE

--i--
GO
CREATE PROC SP_INS_PUBLIC_ENCRYPT_NHANVIEN
(
	@MANV VARCHAR(20),
	@HOTEN NVARCHAR(100),
	@EMAIL VARCHAR(20),
	@LUONG VARBINARY(MAX),
	@TENDN NVARCHAR(100),
	@MATKHAU VARBINARY(MAX),
	@PUB VARCHAR(MAX)
)
AS
	INSERT INTO NHANVIEN(MANV, HOTEN, EMAIL, LUONG, TENDN, MATKHAU, PUBKEY)
	VALUES (@MANV, @HOTEN, @EMAIL, @LUONG, @TENDN, @MATKHAU, @PUB);

--ii--
GO
CREATE PROC SP_SEL_PUBLIC_ENCRYPT_NHANVIEN
(
	@TENDN NVARCHAR(100),
	@MATKHAU VARBINARY(MAX)
)
AS
	SELECT MANV, HOTEN, EMAIL, LUONG
	FROM NHANVIEN
	WHERE TENDN = @TENDN AND MATKHAU = @MATKHAU

--CAC STORED PROC KHAC--
GO
CREATE PROC SP_INS_PUBLIC_ENCRYPT_SINHVIEN
(
	@MASV nvarchar(20),
	@HOTEN nvarchar(100),
	@NGAYSINH datetime,
	@DIACHI nvarchar(200),
	@MALOP varchar(20),
	@TENDN nvarchar(100),
	@MATKHAU varbinary(max)
)
AS
	INSERT INTO SINHVIEN
	VALUES (@MASV, @HOTEN, @NGAYSINH, @DIACHI, @MALOP, @TENDN, @MATKHAU)

EXEC SP_INS_PUBLIC_ENCRYPT_NHANVIEN 'NV12', N'Omega Tooth', 'omega@mail.com', 0x55E5E5DA35A9F7C881CEE6957EAA10FE52FE42A5FEFAC06340B0926EEFC9F0B6B84588545A228EDC03DE128800C8EB6147C4875DA227A86F5911DA939E89CF77B5C9B21654B1A8EE18C5EE8E0EF1CD6F4247C70AF88D63ACB083CC95064052DD9B1164E315BD848A374CBFF4C5F1D6C89010349432BACB668C43CD40451344BBF012466CA74745844F182C7C13ECA4324828158955BC0D153B754433E86920339D34F704AFE0F4725D86278E53BD06854B1A78F34E73ED88CAA1011A7A9331452975EF0FE0DFFA62541348385C163706B4333CA799A5F128666524FC74FA3B70F13622C2A0591120E32152D53AAACD4B4B58A18E6394C5AF9CF9F6B9DF21D3B4, N'omega', 0x34C4EDC6C5364C6B11E8180A01162BADD1070CD7, 'RSA'
-- manv: NV11
-- pass: omegaxxx
-- luong: 4500

SELECT * FROM NHANVIEN where MANV = 'NV12'
SELECT* FROM NHANVIEN

EXEC SP_SEL_PUBLIC_ENCRYPT_NHANVIEN N'omega', 0x34C4EDC6C5364C6B11E8180A01162BADD1070CD7

INSERT INTO LOP VALUES('CNTT-K21', N'CÔNG NGHỆ THÔNG TIN KHÓA 21', 'NV12');
INSERT INTO LOP VALUES('CNTT-K35', N'CÔNG NGHỆ THÔNG TIN KHÓA 35', 'NV12');
INSERT INTO LOP VALUES('CNTT-K46', N'CÔNG NGHỆ THÔNG TIN KHÓA 46', 'NV12');
INSERT INTO LOP VALUES('CNSH-K21', N'CÔNG NGHỆ SINH HỌC KHÓA 21', 'NV11');

EXEC SP_INS_PUBLIC_ENCRYPT_SINHVIEN '21120419', N'VŨ THÀNH CÔNG', '1/1/2003', N'LÂM ĐỒNG', 'CNTT-K21', '21120419', 0xD6FDC1A6004C3A44DC40EC97A8961FAE;
EXEC SP_INS_PUBLIC_ENCRYPT_SINHVIEN '35120001', N'CÔNG THÀNH VŨ', '11/11/2017', N'LONG AN', 'CNTT-K35', '35120001', 0x192A1A8DDDC67D7CFB5EB7AA692FB143;
EXEC SP_INS_PUBLIC_ENCRYPT_SINHVIEN '46120030', N'VŨ CÔNG', '12/12/2028', N'ĐỒNG THÁP', 'CNTT-K46', '46120030', 0x194A5E7DCBEE7955205C8D99C4573090;
EXEC SP_INS_PUBLIC_ENCRYPT_SINHVIEN '21180888', N'ANTONIA PORSIL', '1/1/2003', N'ĐỒNG NAI', 'CNSH-K21', '21180888', 0x196A1A8DDDC68D7CFB5EB7AA692FB143;
-- 21120419 : abcd419
-- 35120001 : abcd001
-- 46120030 : abcd030

INSERT INTO HOCPHAN VALUES('BMCSDL', 'DATABASE SECURITY', 4)
INSERT INTO HOCPHAN VALUES('ANM', 'AN NINH MANG', 4)
INSERT INTO HOCPHAN VALUES('QHTT', 'QUY HOACH TUYEN TINH', 4)
INSERT INTO HOCPHAN VALUES('SHGP', 'SINH HOC GIAI PHAU', 4)

INSERT INTO BANGDIEM 
VALUES
('21120419', 'BMCSDL', 0x3AC2186B6F7B1553AE1333C089E7F8004DC951964C1C7B17A096690BFAA3058CBA921648B9AD58E1F8762AF068D73F8F220CBA5629C7CB493923BEDC2C865F5E4DF2F80E24CAD63A4FC02996279FFA70E670EE269888AC0359B3A0FFE2097584A6D91BA33E89D3525AE46FA67F892EDACC54EBE7ADB16271B1F69C9418947188522BA1F1D801CBEC858B42377EF87DAB9A7D02CBDD1FB74B598EBD9D001C8E91D3BC86BA3C187259AE6FF350071C762ED349088D3BDE72E1CF6B38EE3C82C6C27F0202386E01570F92C943CD2E08497DBFC13A690377F8346EA6E496BA9F0393DE6AAF138D8C1A26674F7CA50921E3FDA768AFA22A0B6F83D362D381D6E14703),
('21120419', 'QHTT', 0x3AC2186B6F7B1553AE1333C089E7F8004DC951964C1C7B17A096690BFAA3058CBA921648B9AD58E1F8762AF068D73F8F220CBA5629C7CB493923BEDC2C865F5E4DF2F80E24CAD63A4FC02996279FFA70E670EE269888AC0359B3A0FFE2097584A6D91BA33E89D3525AE46FA67F892EDACC54EBE7ADB16271B1F69C9418947188522BA1F1D801CBEC858B42377EF87DAB9A7D02CBDD1FB74B598EBD9D001C8E91D3BC86BA3C187259AE6FF350071C762ED349088D3BDE72E1CF6B38EE3C82C6C27F0202386E01570F92C943CD2E08497DBFC13A690377F8346EA6E496BA9F0393DE6AAF138D8C1A26674F7CA50921E3FDA768AFA22A0B6F83D362D381D6E14703),
('35120001', 'ANM', 0x3AC2186B6F7B1553AE1333C089E7F8004DC951964C1C7B17A096690BFAA3058CBA921648B9AD58E1F8762AF068D73F8F220CBA5629C7CB493923BEDC2C865F5E4DF2F80E24CAD63A4FC02996279FFA70E670EE269888AC0359B3A0FFE2097584A6D91BA33E89D3525AE46FA67F892EDACC54EBE7ADB16271B1F69C9418947188522BA1F1D801CBEC858B42377EF87DAB9A7D02CBDD1FB74B598EBD9D001C8E91D3BC86BA3C187259AE6FF350071C762ED349088D3BDE72E1CF6B38EE3C82C6C27F0202386E01570F92C943CD2E08497DBFC13A690377F8346EA6E496BA9F0393DE6AAF138D8C1A26674F7CA50921E3FDA768AFA22A0B6F83D362D381D6E14703),
('46120030', 'BMCSDL', 0x3AC2186B6F7B1553AE1333C089E7F8004DC951964C1C7B17A096690BFAA3058CBA921648B9AD58E1F8762AF068D73F8F220CBA5629C7CB493923BEDC2C865F5E4DF2F80E24CAD63A4FC02996279FFA70E670EE269888AC0359B3A0FFE2097584A6D91BA33E89D3525AE46FA67F892EDACC54EBE7ADB16271B1F69C9418947188522BA1F1D801CBEC858B42377EF87DAB9A7D02CBDD1FB74B598EBD9D001C8E91D3BC86BA3C187259AE6FF350071C762ED349088D3BDE72E1CF6B38EE3C82C6C27F0202386E01570F92C943CD2E08497DBFC13A690377F8346EA6E496BA9F0393DE6AAF138D8C1A26674F7CA50921E3FDA768AFA22A0B6F83D362D381D6E14703),
('21180888', 'SHGP', 0x3AC2186B6F7B1553AE1333C089E7F8004DC951964C1C7B17A096690BFAA3058CBA921648B9AD58E1F8762AF068D73F8F220CBA5629C7CB493923BEDC2C865F5E4DF2F80E24CAD63A4FC02996279FFA70E670EE269888AC0359B3A0FFE2097584A6D91BA33E89D3525AE46FA67F892EDACC54EBE7ADB16271B1F69C9418947188522BA1F1D801CBEC858B42377EF87DAB9A7D02CBDD1FB74B598EBD9D001C8E91D3BC86BA3C187259AE6FF350071C762ED349088D3BDE72E1CF6B38EE3C82C6C27F0202386E01570F92C943CD2E08497DBFC13A690377F8346EA6E496BA9F0393DE6AAF138D8C1A26674F7CA50921E3FDA768AFA22A0B6F83D362D381D6E14703)

SELECT * FROM HOCPHAN
SELECT* FROM BANGDIEM
SELECT* FROM SINHVIEN

--stored proc ho tro winforms--
GO
CREATE PROC SP_SEL_DSSV
(
	@MALOP VARCHAR (20)
)
AS
	SELECT SV.MASV, SV.HOTEN, HP.MAHP, HP.TENHP, BD.DIEMTHI
	FROM SINHVIEN SV JOIN LOP ON SV.MALOP = LOP.MALOP 
			JOIN BANGDIEM BD ON BD.MASV = SV.MASV
			JOIN HOCPHAN HP ON HP.MAHP = BD.MAHP
	WHERE LOP.MALOP = @MALOP

GO
CREATE PROC SP_SEL_TO_INSERT_DSSV
(
	@MALOP VARCHAR (20)
)
AS
	SELECT SV.MASV, HP.MAHP, BD.DIEMTHI
	FROM SINHVIEN SV JOIN LOP ON SV.MALOP = LOP.MALOP 
			JOIN BANGDIEM BD ON BD.MASV = SV.MASV
			JOIN HOCPHAN HP ON HP.MAHP = BD.MAHP
	WHERE LOP.MALOP = @MALOP
